/*
 * SAM_TouchButton.c
 *
 *  Created on: 12.02.2019
 *      Author: dinkelsv64505
 */

#include "SourceActionManager/SAM_TouchButton.h"

#include "SourceActionManager/SAM_Init.h"
#include "HardwareUtil/HW_Init.h"

#include "HardwareUtil/HW_I2C.h"

#include "Debug/DB_Console.h"

//0x0E, 0xFA, 0x92, 0x10,

static const uint8_t initSPMData[] = {
		0x00, 0x00, 0x19, 0x00, 0x2B, 0x02, 0x0D, 0x00,
		0x00, 0x01, 0x17, 0xDF, 0xD5, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0,
		0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0x00,

		0x00, 0x30, 0x50, 0x50, 0x01, 0x01, 0x01, 0x01,
		0x01, 0x03, 0xff, 0x01, 0x40, 0x50, 0x50, 0x01,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
		0x54, 0x32, 0x10, 0x00, 0x00, 0x00, 0x00, 0x02,

		0x00, 0x00, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x44, 0x44,

		0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50,
		0x46, 0x10, 0x45, 0x02, 0xff, 0xff, 0xff, 0xd5,
		0x55, 0x55, 0x7f, 0x23, 0x22, 0x41, 0xff, 0x74
};

//static const uint8_t initSPMData[] = {
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
//
//};

void sam_tb_programSPM(uint8_t baseAdress, const uint8_t* spmData);
void sma_tb_readSPM(uint8_t baseAdress, uint8_t* dataBuffer);

void sam_tb_init()
{

	SAM_PIN_TB_INT = 0xfff0; //Define as GPIOInput

	hw_init_registerPinIdentfier(SAM_PIN_ID_TB_INT, &SAM_PIN_TB_INT);

}

void sam_tb_initHW()
{
	if(SAM_PIN_TB_INT < 0xfff0){
		db_cs_printString("Init TouchButton HW...\r");

		//hw_i2c_write(uint8_t addr, uint8_t *data, uint8_t length, uint8_t wait, uint8_t end);
		//int i = 1;
		for(int i = 0; i < 16; i++){ //16
			db_cs_printString("Program Touch SPM: ");
			db_cs_printInt(i);
			db_cs_printString("\r");
			sam_tb_programSPM(i*8, &initSPMData[i*8]);
		}

		uint8_t data[8];
		for(int i = 0; i < 16; i++){ //16
			db_cs_printString("Read Addr ");
			db_cs_printInt(i);
			db_cs_printString("\r");
			sma_tb_readSPM(i*8, data);
		}

	}
}

void sam_tb_programSPM(uint8_t baseAdress, const uint8_t* spmData){
	uint8_t sendData[16];
	sendData[0] = 0x0D; //SpmCfg Register
	sendData[1] = 0x10; //Enable SPM Write

	db_cs_printString("SpmCfg write");
	hw_i2c_write(SX8635_ADDR, sendData, 2, 1, 1);

	sendData[0] = 0x0E; //BaseAddr Register
	sendData[1] = baseAdress;

	db_cs_printString("BaseAddr write");
	hw_i2c_write(SX8635_ADDR, sendData, 2, 1, 1);

	sendData[0] = 0x00; //BaseAddr SPM Write Register

	for(int i = 0; i < 8; i++){ //SPM Register
		sendData[i+1] = spmData[i];
	}

	db_cs_printString("Write SPM");
	hw_i2c_write(SX8635_ADDR, sendData, 9, 1, 1);


	sendData[0] = 0x0D; //SpmCfg Register
	sendData[1] = 0x00; //Terminate write

	db_cs_printString("Reset SpmCfg");
	hw_i2c_write(SX8635_ADDR, sendData, 2, 1, 1);

	db_cs_printString("WAIT");
	//for(int i = 0; i < 500000; i++){} //Sleep ~30ms
	for(int i = 0; i < 10000; i++){
		db_cs_printString("");
	} //Sleep ~30ms

	hw_i2c_read(SX8635_ADDR, 0x00, 1);

}

void sma_tb_readSPM(uint8_t baseAdress, uint8_t* dataBuffer){
	uint8_t sendData[16];
	sendData[0] = 0x0D; //SpmCfg Register
	sendData[1] = 0x18; //Enable SPM Write

	db_cs_printString("SpmCfg write");
	hw_i2c_write(SX8635_ADDR, sendData, 2, 1, 1);

	sendData[0] = 0x0E; //BaseAddr Register
	sendData[1] = baseAdress;

	db_cs_printString("BaseAddr write");
	hw_i2c_write(SX8635_ADDR, sendData, 2, 1, 1);

	db_cs_printString("Read SPM");
	hw_i2c_read(SX8635_ADDR, 0x00, 8);


	sendData[0] = 0x0D; //SpmCfg Register
	sendData[1] = 0x00; //Terminate write

	db_cs_printString("Reset SpmCfg");
	hw_i2c_write(SX8635_ADDR, sendData, 2, 1, 1);
}

void sam_tb_notifyEvent()
{

}
